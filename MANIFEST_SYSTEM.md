# Manifest System

## Problem

Previously, the importer had a critical issue: when importing a single volume (e.g., `bun run import:pgp`), 
the `generateManifest()` function would overwrite the entire `public/scripture/manifest.json` file with only 
the newly imported volume's metadata, effectively erasing information about all other volumes.

This meant:
- ❌ Importing one volume would delete metadata for all others
- ❌ You had to import all volumes together to maintain the full manifest
- ❌ No way to update a single volume without affecting others

## Solution

The manifest system has been restructured so that **each volume manages its own manifest file**:

```
public/scripture/
├── manifest.json                          # Root manifest (auto-generated)
└── translations/
    ├── bofm/
    │   ├── manifest.json                  # Book of Mormon manifest
    │   └── ...
    ├── kjv/
    │   ├── manifest.json                  # King James Version manifest (OT + NT)
    │   └── ...
    ├── dc/
    │   ├── manifest.json                  # Doctrine & Covenants manifest
    │   └── ...
    └── pgp/
        ├── manifest.json                  # Pearl of Great Price manifest
        └── ...
```

### How It Works

1. **Volume-Specific Manifests**: Each translation has its own `manifest.json` file in its directory
2. **Automatic Merging**: The root manifest is generated by reading all volume manifests
3. **Incremental Updates**: Importing one volume only updates its own manifest

## Code Changes

### 1. `importPipeline.ts`

#### Old: `generateManifest()`
```typescript
// OLD - overwrites entire manifest
export async function generateManifest(
  translations: Array<{ id: string; books: Book[] }>
): Promise<ScriptureManifest>
```

#### New: `generateVolumeManifest()` + `generateRootManifest()`
```typescript
// NEW - generates/updates volume-specific manifest
export async function generateVolumeManifest(
  translationId: string,
  books: Book[],
  volumeConfig: VolumeConfig
): Promise<TranslationManifest>

// NEW - aggregates all volume manifests into root
export async function generateRootManifest(): Promise<ScriptureManifest>
```

**Key Features:**
- `generateVolumeManifest()` merges with existing manifest (useful for KJV OT+NT)
- Handles duplicate books gracefully
- `generateRootManifest()` scans all translation directories and aggregates their manifests

### 2. `import.ts`

Changed from collecting all translations and generating a single manifest at the end, to:
- Generate volume-specific manifest after each import
- Generate root manifest at the very end

```typescript
// OLD
const translations: Array<{ id: string; books: any[] }> = [];
// ... collect translations ...
await ImportPipeline.generateManifest(translations);

// NEW
if (source === 'bofm' || source === 'all') {
  const bofmBooks = await ImportPipeline.importBookOfMormon();
  await ImportPipeline.generateVolumeManifest('bofm', bofmBooks, BOOK_OF_MORMON);
}
// ... repeat for each volume ...
await ImportPipeline.generateRootManifest();
```

### 3. `generate-manifests.ts` (New Utility)

A standalone script to regenerate all manifests from volume configs:

```bash
bun scripts/generate-manifests.ts
```

Useful for:
- Rebuilding manifests after manual data corrections
- Initializing manifests for existing data
- Updating manifest structure after schema changes

## Usage

### Import Single Volume

```bash
# Import just Pearl of Great Price
bun run import:pgp
```

**Result:**
- ✅ Creates/updates `public/scripture/translations/pgp/manifest.json`
- ✅ Updates root `public/scripture/manifest.json` with all volumes
- ✅ Leaves other volume manifests untouched

### Import Multiple Volumes

```bash
# Import Old Testament and New Testament separately
bun run import:ot
bun run import:nt
```

**Result:**
- ✅ Both import to `kjv/` directory
- ✅ Manifests merge automatically (no duplicate books)
- ✅ Root manifest shows complete KJV with all 66 books

### Import All Volumes

```bash
bun run import:all
```

**Result:**
- ✅ Imports all 5 volumes
- ✅ Each gets its own manifest
- ✅ Root manifest aggregates all

### Regenerate Manifests

```bash
# Rebuild all manifests from existing data and volume configs
bun scripts/generate-manifests.ts
```

## Benefits

### ✅ Incremental Updates
Import or re-import individual volumes without affecting others.

### ✅ Atomic Operations
Each volume is self-contained with its own metadata.

### ✅ Better Organization
Clear separation of concerns - each translation manages its own manifest.

### ✅ Merge-Friendly
KJV Old Testament and New Testament can be imported separately and merge automatically.

### ✅ Recovery
If root manifest gets corrupted, it can be regenerated from volume manifests.

## Migration

All existing volumes now have their own manifests:
- `public/scripture/translations/bofm/manifest.json` - ✅ Created
- `public/scripture/translations/kjv/manifest.json` - ✅ Created (66 books: OT + NT)
- `public/scripture/translations/dc/manifest.json` - ✅ Created
- `public/scripture/translations/pgp/manifest.json` - ✅ Created

Root manifest regenerated with all 4 translations: ✅

## Testing

Run the imports to verify:

```bash
# Test single volume import (should not affect others)
bun run import:pgp

# Verify all 4 translations still in root manifest
cat public/scripture/manifest.json | jq '.translations | map(.id)'
# Expected: ["kjv", "bofm", "dc", "pgp"]

# Test manifest regeneration
bun scripts/generate-manifests.ts
```

## See Also

- [QUICK_IMPORT_GUIDE.md](./QUICK_IMPORT_GUIDE.md) - Import guide with updated manifest information
- [scripts/README.md](./scripts/README.md) - Detailed script documentation
- [ARCHITECTURE.md](./ARCHITECTURE.md) - Overall system architecture

